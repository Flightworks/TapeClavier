<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tap Tap Clavier ‚Äî Cassandre (5 ans)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Comic Sans MS',cursive,sans-serif;
      background:linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%);
      height:100vh;overflow:hidden;display:grid;
      grid-template-columns:300px 1fr 300px;grid-template-rows:auto 1fr;
      gap:clamp(8px,1.6vh,16px);padding:clamp(8px,1.6vh,16px);
      transition:background .3s,color .3s
    }
    .header{position:relative;grid-column:1/-1;background:rgba(255,255,255,.96);border-radius:20px;padding:clamp(8px,1.6vh,16px);text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .header h1{color:#ff7a59;font-size:clamp(1.2rem,3vh,2rem);margin-bottom:4px;text-shadow:2px 2px 4px rgba(0,0,0,.08)}
    .sub{font-size:clamp(.9rem,2vh,1.1rem);color:#f76707}

    .left,.main,.right{background:rgba(255,255,255,.96);border-radius:20px;padding:clamp(10px,1.8vh,18px);box-shadow:0 10px 30px rgba(0,0,0,.1);min-height:0}
    .left,.right{display:flex;flex-direction:column;gap:clamp(10px,1.6vh,18px);overflow:auto}
    .main{display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}

    .panel-title{font-size:clamp(1rem,2.2vh,1.15rem);color:#ff7a59;font-weight:bold;margin-bottom:6px;text-align:center;border-bottom:2px solid #ffe3d5;padding-bottom:6px}

    .stats{display:grid;grid-template-columns:1fr 1fr;gap:clamp(6px,1vh,12px)}
    .stat{background:linear-gradient(45deg,#ff9a9e,#fad0c4);border-radius:15px;padding:clamp(8px,1.4vh,14px);text-align:center;color:#fff;text-shadow:1px 1px 2px rgba(0,0,0,.3)}
    .stat-number{font-size:clamp(1.1rem,2.4vh,1.6rem);font-weight:bold;display:block}

    .options{background:#fff7f2;border-radius:15px;padding:clamp(10px,1.6vh,16px);display:grid;gap:10px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .checks{display:flex;gap:8px;flex-wrap:wrap}
    .checks label{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid #ffe3d5;padding:6px 10px;border-radius:10px}
    .mode-btn{flex:1;padding:10px;border:2px solid #ffd0bd;border-radius:12px;background:#fff;cursor:pointer;font-weight:bold}
    .mode-btn.active{background:linear-gradient(45deg,#ff7a59,#f76707);color:#fff;border-color:transparent}

    .prompt{background:linear-gradient(45deg,#fff,#fff7f2);border-radius:22px;padding:clamp(12px,2.5vh,24px);margin:clamp(10px,1.6vh,16px) 0;font-size:clamp(1.8rem,7vh,3rem);font-weight:bold;color:#333;min-height:clamp(80px,20vh,160px);display:flex;align-items:center;justify-content:center;text-shadow:1px 1px 2px rgba(0,0,0,.04)}

    .letters-track{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .letter-box{font-size:clamp(1.2rem,4vh,1.8rem);min-width:38px;min-height:46px;display:flex;align-items:center;justify-content:center;border-radius:10px;padding:6px 10px;border:2px solid #ffe3d5;background:#fff}
    .letter-box.done{background:#e8f8e8;border-color:#c3efc3}
    .letter-box.current{background:#fff2cc;border-color:#ffd85e}

    .btns{display:flex;gap:clamp(6px,1vh,12px);flex-wrap:wrap;justify-content:center}
    .btn{font-size:clamp(1rem,2.2vh,1.1rem);padding:clamp(8px,1.4vh,12px) clamp(14px,2.5vh,22px);border:none;border-radius:25px;cursor:pointer;font-weight:bold;transition:transform .2s,box-shadow .2s}
    .btn:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .btn-primary{background:linear-gradient(45deg,#ff7a59,#f76707);color:#fff}
    .btn-outline{background:#fff;border:2px solid #ffd0bd;color:#444}
    .btn-success{background:linear-gradient(45deg,#a8edea,#fed6e3);color:#2d5a27}

    .feedback{margin:clamp(8px,1.4vh,14px) 0;padding:clamp(10px,1.6vh,14px);border-radius:20px;font-size:clamp(1rem,2.2vh,1.1rem);font-weight:bold;min-height:clamp(38px,6vh,60px);display:flex;align-items:center;justify-content:center}
    .feedback.ok{background:linear-gradient(45deg,#a8edea,#fed6e3);color:#2d5a27}
    .feedback.ko{background:linear-gradient(45deg,#ffeaa7,#fab1a0);color:#d63031}

    .kb{user-select:none;margin-top:10px;display:grid;gap:6px}
    .kb-row{display:flex;justify-content:center;gap:6px}
    .key{background:#fff;border:2px solid #ffd0bd;border-radius:10px;min-width:42px;min-height:50px;padding:8px 10px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:clamp(1rem,2.3vh,1.2rem);cursor:pointer;transition:transform .05s, background .2s, border-color .2s}
    .key.active{transform:translateY(2px);background:#fff2cc;border-color:#ffd85e}
    .key.target{background:#e8f8ff;border-color:#bfe6ff}

    .timer{background:linear-gradient(45deg,#ff7a59,#f76707);color:#fff;padding:10px;border-radius:14px;text-align:center;font-weight:bold}
    .progress{background:#ffe3d5;border-radius:10px;height:10px;margin-top:6px;overflow:hidden}
    .fill{background:linear-gradient(90deg,#ff7a59,#f76707);height:100%;width:0%;transition:width .3s}

    .achievements{background:#fff7f2;border-radius:15px;padding:clamp(10px,1.6vh,16px)}
    .ach{display:flex;align-items:center;gap:10px;padding:10px;margin:4px 0;border-radius:10px}
    .ach.locked{background:#f6f6f6;color:#999}
    .ach.unlocked{background:linear-gradient(45deg,#a8edea,#fed6e3);color:#2d5a27}

    .history{max-height:32vh;overflow:auto}
    .hitem{display:flex;justify-content:space-between;align-items:center;padding:8px;margin:3px 0;border-radius:8px;font-size:.9em}
    .hitem.ok{background:#e8f5e8;color:#2d5a27}
    .hitem.ko{background:#ffe8e8;color:#d63031}

    .celebration{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000}
    .confetti{position:absolute;width:10px;height:10px;background:#ff6b6b;animation:fall 3s linear forwards}
    @keyframes fall{0%{transform:translateY(-100vh) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(360deg);opacity:0}}

    /* Dark mode */
    body.dark{background:linear-gradient(135deg,#1f2437 0%,#2b2e4a 100%)}
    body.dark .header, body.dark .left, body.dark .right, body.dark .main{background:rgba(18,18,20,.92);color:#f1f1f1}
    body.dark .panel-title{color:#ffd0bd;border-color:#2a2a33}
    body.dark .key{background:#1f2130;border-color:#3b3f63;color:#f1f1f1}
    body.dark .key.target{background:#2a2d44;border-color:#5b5fa0}

    @media (max-width:900px){
      body{grid-template-columns:1fr;grid-template-rows:auto 1fr auto auto}
      .left,.right{order:2;height:34vh}
      .main{order:1;height:40vh}
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="../" style="position:absolute;top:clamp(8px,1.6vh,16px);right:clamp(8px,1.6vh,16px);padding:8px 12px;background:#ff7a59;color:white;text-decoration:none;border-radius:12px;font-size:clamp(.8rem,1.8vh,1rem);">Retour au menu</a>
    <h1>üéπ Tap Tap Clavier ‚Äî Cassandre</h1>
    <div class="sub">Apprendre √† taper en jouant (5 ans)</div>
  </div>

  <div class="left" aria-label="R√©glages et statistiques">
    <div class="panel-title">üìä Statistiques</div>
    <div class="stats">
      <div class="stat"><span class="stat-number" id="score">0</span>Score</div>
      <div class="stat"><span class="stat-number" id="streak">0</span>S√©rie</div>
      <div class="stat"><span class="stat-number" id="total">0</span>Total</div>
      <div class="stat"><span class="stat-number" id="acc">0%</span>Pr√©cision</div>
    </div>

    <div class="options">
      <div class="panel-title">üéØ Mode</div>
      <div class="row">
        <button class="mode-btn active" id="mode-letter" onclick="setMode('letter')">Lettre cible</button>
        <button class="mode-btn" id="mode-name" onclick="setMode('name')">Mon pr√©nom</button>
        <button class="mode-btn" id="mode-words" onclick="setMode('words')">Mots faciles</button>
      </div>

      <div class="panel-title">‚öôÔ∏è Options</div>
      <div class="row"><label class="checks"><input type="checkbox" id="opt-vowels" checked> Voyelles</label><label class="checks"><input type="checkbox" id="opt-easy" checked> Consonnes faciles</label><label class="checks"><input type="checkbox" id="opt-azerty-top"> Ligne AZERTY haut</label></div>
      <div class="row"><label class="checks"><input type="checkbox" id="opt-full"> Alphabet complet</label><label class="checks"><input type="checkbox" id="opt-uppercase" checked> Afficher en MAJUSCULES</label></div>
      <div class="row"><label class="checks"><input type="checkbox" id="opt-sound" checked> Sons</label><label class="checks"><input type="checkbox" id="opt-tts" checked> Lire la consigne</label><label class="checks"><input type="checkbox" id="opt-dark"> Mode sombre</label></div>
      <div class="row" style="justify-content:center"><button class="btn btn-outline" onclick="exportCSV()">üì§ Exporter CSV</button><button class="btn btn-outline" onclick="resetStats()">‚ôªÔ∏è R√©initialiser</button></div>
    </div>

    <div class="timer" id="timer">Temps par item: <span id="tps">--</span>s
      <div class="progress"><div class="fill" id="fill" style="width:0%"></div></div>
    </div>
  </div>

  <div class="main">
    <div class="prompt" id="prompt">Clique sur "Nouveau" pour commencer Cassandre !</div>
    <div class="letters-track" id="track"></div>

    <div class="btns">
      <button class="btn btn-primary" onclick="newPrompt()">Nouveau</button>
      <button class="btn btn-success" onclick="repeat()">üîä R√©√©couter</button>
      <button class="btn btn-outline" onclick="giveHint()">Indice</button>
    </div>

    <div class="feedback" id="fb"></div>

    <div class="kb" id="kb" aria-label="Clavier visuel">
      <div class="kb-row" id="row1"></div>
      <div class="kb-row" id="row2"></div>
      <div class="kb-row" id="row3"></div>
    </div>
  </div>

  <div class="right">
    <div class="panel-title">üèÜ Succ√®s</div>
    <div class="achievements" id="achs">
      <div class="ach locked" data-id="first"><span>üåü</span><span>Premi√®re lettre</span></div>
      <div class="ach locked" data-id="streak5"><span>üî•</span><span>5 d'affil√©e</span></div>
      <div class="ach locked" data-id="word"><span>üßÅ</span><span>Premier mot</span></div>
      <div class="ach locked" data-id="name"><span>üéà</span><span>Pr√©nom termin√©</span></div>
      <div class="ach locked" data-id="total50"><span>üìö</span><span>50 items</span></div>
    </div>

    <div class="panel-title">üìù Historique</div>
    <div class="history" id="hist"><div style="text-align:center;color:#999;padding:20px;">L'historique appara√Ætra ici</div></div>
  </div>

  <div class="celebration" id="cel"></div>
  <input id="trap" style="position:absolute;opacity:0;pointer-events:none" />

  <audio id="snd-ok" preload="auto"><source src="data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHGZmZmY=" type="audio/wav"></audio>
  <audio id="snd-ko" preload="auto"><source src="data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHGZmZmY=" type="audio/wav"></audio>

<script>
(function(){
  // ====== √âTAT ======
  const KEY='cassandre_typing_v1';
  let mode='letter';
  let target=null; // string pour word/name, char pour letter
  let index=0; // progression dans target
  let score=0, streak=0, total=0, okCount=0;
  let startItem=null; // timestamp
  const historyRows=[]; // pour CSV

  const settings={
    vowels:true, easy:true, azertyTop:false, full:false, uppercase:true,
    sound:true, tts:true, dark:false
  };

  const LETTERS_VOWELS=['A','E','I','O','U','Y'];
  const LETTERS_EASY=['M','N','S','R','L','T','P','C','D','B','F'];
  const AZERTY_TOP=['A','Z','E','R','T','Y','U','I','O','P'];
  const FULL='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
  const NAME='CASSANDRE';
  const WORDS=['MAMAN','PAPA','LUNE','CHAT','LILI','RIRE','SOURI','COCO','NINA','TOM'];

  const $=s=>document.querySelector(s);
  const els={
    score:$('#score'), streak:$('#streak'), total:$('#total'), acc:$('#acc'),
    prompt:$('#prompt'), track:$('#track'), fb:$('#fb'),
    row1:$('#row1'), row2:$('#row2'), row3:$('#row3'), kb:$('#kb'),
    sndOK:$('#snd-ok'), sndKO:$('#snd-ko'),
    tps:$('#tps'), fill:$('#fill'), cel:$('#cel'), hist:$('#hist'),
    trap:$('#trap'),
    modeLetter:$('#mode-letter'), modeName:$('#mode-name'), modeWords:$('#mode-words'),
    optV:$('#opt-vowels'), optE:$('#opt-easy'), optAT:$('#opt-azerty-top'), optF:$('#opt-full'),
    optU:$('#opt-uppercase'), optS:$('#opt-sound'), optT:$('#opt-tts'), optD:$('#opt-dark')
  };

  // ----- Chargement -----
  function load(){
    try{ const d=JSON.parse(localStorage.getItem(KEY)||'null'); if(!d) return; Object.assign(settings,d.settings||{}); score=d.score||0; streak=d.streak||0; total=d.total||0; okCount=d.okCount||0; }catch(e){}
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify({settings,score,streak,total,okCount})); }
  load();
  applySettingsToUI(); updateStats();

  // ----- Clavier visuel AZERTY (lettres) -----
  const ROW1=['A','Z','E','R','T','Y','U','I','O','P'];
  const ROW2=['Q','S','D','F','G','H','J','K','L','M'];
  const ROW3=['W','X','C','V','B','N'];
  function buildKB(){
    buildRow(els.row1, ROW1); buildRow(els.row2, ROW2); buildRow(els.row3, ROW3);
  }
  function buildRow(container, keys){
    container.innerHTML='';
    keys.forEach(k=>{
      const b=document.createElement('button'); b.className='key'; b.setAttribute('data-key',k);
      b.textContent=k; b.addEventListener('click',()=> handleInput(k));
      container.appendChild(b);
    });
  }
  buildKB();

  // ----- UI / Options -----
  function applySettingsToUI(){
    els.optV.checked=settings.vowels; els.optE.checked=settings.easy; els.optAT.checked=settings.azertyTop; els.optF.checked=settings.full; els.optU.checked=settings.uppercase; els.optS.checked=settings.sound; els.optT.checked=settings.tts; els.optD.checked=settings.dark;
    document.body.classList.toggle('dark', settings.dark);
  }

  els.optV.addEventListener('change', ()=>{ settings.vowels=els.optV.checked; save(); });
  els.optE.addEventListener('change', ()=>{ settings.easy=els.optE.checked; save(); });
  els.optAT.addEventListener('change', ()=>{ settings.azertyTop=els.optAT.checked; save(); });
  els.optF.addEventListener('change', ()=>{ settings.full=els.optF.checked; save(); });
  els.optU.addEventListener('change', ()=>{ settings.uppercase=els.optU.checked; updatePromptDisplay(); save(); });
  els.optS.addEventListener('change', ()=>{ settings.sound=els.optS.checked; save(); });
  els.optT.addEventListener('change', ()=>{ settings.tts=els.optT.checked; save(); });
  els.optD.addEventListener('change', ()=>{ settings.dark=els.optD.checked; document.body.classList.toggle('dark', settings.dark); save(); });

  window.setMode=function(m){ mode=m; ['letter','name','words'].forEach(x=> $('#mode-'+x).classList.toggle('active', x===m)); newPrompt(); };

  // ----- G√©n√©ration du set de lettres -----
  function currentLetterPool(){
    if(settings.full) return FULL.slice();
    let pool=[];
    if(settings.vowels) pool=pool.concat(LETTERS_VOWELS);
    if(settings.easy) pool=pool.concat(LETTERS_EASY);
    if(settings.azertyTop) pool=pool.concat(AZERTY_TOP);
    // d√©doublonnage
    return [...new Set(pool)];
  }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  // ----- Nouvelle consigne -----
  window.newPrompt=function(){
    index=0; startItem=Date.now(); setFill(0); els.fb.textContent=''; els.fb.className='feedback';
    if(mode==='letter'){
      const pool=currentLetterPool(); if(pool.length===0) pool.push('A');
      target=pick(pool);
      els.track.innerHTML='';
      updatePromptDisplay();
      highlightTargetKey(target);
      speak(`Tape la lettre ${target}`);
    }else if(mode==='name'){
      target=NAME; buildTrack(target); updatePromptDisplay(); highlightTargetKey(target[0]); speak(`Tape ton pr√©nom: ${target}`);
    }else{ // words
      target=pick(WORDS); buildTrack(target); updatePromptDisplay(); highlightTargetKey(target[0]); speak(`Tape le mot: ${target}`);
    }
    // focus pi√©ge √† touches (mobile)
    els.trap.focus();
  };

  function buildTrack(word){
    els.track.innerHTML='';
    word.split('').forEach((ch,i)=>{
      const b=document.createElement('div'); b.className='letter-box'+(i===0?' current':''); b.textContent=displayChar(ch);
      els.track.appendChild(b);
    });
  }

  function updatePromptDisplay(){
    if(!target){ els.prompt.textContent=''; return; }
    if(mode==='letter'){
      els.prompt.textContent = `Tape : ${displayChar(target)}`;
    }else{
      const shown = target.split('').map((c,i)=> i<index? '‚Ä¢' : displayChar(c)).join(' ');
      els.prompt.textContent = shown;
    }
  }
  function displayChar(ch){ return settings.uppercase? ch.toUpperCase() : ch.toLowerCase(); }

  // ----- Entr√©es clavier / √©cran -----
  function normalizeKey(k){ return k.toUpperCase(); }

  document.addEventListener('keydown', (e)=>{
    if(e.key.length===1){ const ch=normalizeKey(e.key); if(ch>='A' && ch<='Z'){ handleInput(ch); } }
    if(e.key==='Backspace' && mode!=='letter' && index>0){ index--; markTrack(index,false); highlightTargetKey(target[index]); updatePromptDisplay(); }
  });

  function handleInput(ch){
    if(!target) return;
    pulseKey(ch);
    const elapsed = Math.floor((Date.now()-startItem)/1000);
    if(mode==='letter'){
      total++;
      const ok = (normalizeKey(ch)===normalizeKey(target));
      if(ok){
        if(settings.sound) playOK(); okCount++; streak++; score++; feedbackOK(`Bravo Cassandre !`); unlock('first');
        addHist(`Lettre ${target}`, ch, ok, elapsed);
        confetti(60);
        if(settings.tts) speak(`${target}`);
      }else{
        if(settings.sound) playKO(); streak=0; feedbackKO(`Essaie encore : ${displayChar(target)}`); addHist(`Lettre ${target}`, ch, false, elapsed);
      }
      updateStats(); save();
      // auto nouveau
      setTimeout(()=> newPrompt(), ok? 900:0);
    }else{
      // mots / pr√©nom
      const expected = target[index];
      const ok = (normalizeKey(ch)===normalizeKey(expected));
      if(ok){
        markTrack(index,true); index++; if(index<target.length){ highlightTargetKey(target[index]); } updatePromptDisplay();
        if(index===target.length){
          total++; okCount++; streak++; score++;
          if(settings.sound) playOK();
          addHist(mode==='name'? 'Pr√©nom' : 'Mot', target, true, elapsed);
          feedbackOK(mode==='name'? 'Pr√©nom termin√© üéà':'Super mot üßÅ');
          if(mode==='name') unlock('name'); else unlock('word');
          confetti(120);
          updateStats(); save();
          setTimeout(()=> newPrompt(), 1200);
        }
      }else{
        if(settings.sound) playKO(); streak=0; feedbackKO(`Regarde la touche en bleu`); addHist((mode==='name'?'Pr√©nom ':'Mot ')+target, ch, false, elapsed);
        flashTarget();
      }
    }
  }

  function markTrack(i,done){
    const el=els.track.children[i]; if(!el) return; el.classList.remove('current'); if(done){ el.classList.add('done'); if(els.track.children[i+1]) els.track.children[i+1].classList.add('current'); }
  }

  // ----- Timer visuel simple -----
  setInterval(()=>{
    if(!startItem) return; const s=Math.floor((Date.now()-startItem)/1000); els.tps.textContent=s; const w=Math.min(100,(s/20)*100); setFill(w);
  }, 1000);
  function setFill(w){ els.fill.style.width=w+'%'; }

  // ----- Feedback / Audio -----
  function feedbackOK(msg){ els.fb.textContent=msg; els.fb.className='feedback ok'; }
  function feedbackKO(msg){ els.fb.textContent=msg; els.fb.className='feedback ko'; }
  function playOK(){ try{ els.sndOK.currentTime=0; els.sndOK.play(); }catch(e){} }
  function playKO(){ try{ els.sndKO.currentTime=0; els.sndKO.play(); }catch(e){} }

  function speak(txt){ if(!settings.tts) return; if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(txt); u.lang='fr-FR'; u.rate=1.0; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); }
  window.repeat=function(){ if(!target) return; if(mode==='letter') speak(`Tape la lettre ${target}`); else speak(`Tape ${target}`); };
  window.giveHint=function(){ flashTarget(); if(mode==='letter') speak(`${target}`); else if(index<target.length) speak(`${target[index]}`); };

  // ----- Achievements -----
  function unlock(id){ const el=document.querySelector(`.ach[data-id="${id}"]`); if(el && el.classList.contains('locked')){ el.classList.remove('locked'); el.classList.add('unlocked'); pulse(el); } }

  // milestones
  function updateStats(){ const acc= total? (okCount/total)*100 : 0; els.score.textContent=score; els.streak.textContent=streak; els.total.textContent=total; els.acc.textContent=acc.toFixed(0)+'%'; if(total>=50) unlock('total50'); if(streak>=5) unlock('streak5'); }

  // ----- Historique & Export -----
  function addHist(item, typed, ok, sec){
    const d=new Date().toLocaleTimeString('fr-FR');
    const row=document.createElement('div'); row.className='hitem '+(ok?'ok':'ko'); row.innerHTML=`<span>${item}</span><span>${ok?'‚úîÔ∏è':'‚úñÔ∏è'} ¬∑ ${typed} ¬∑ ${sec}s</span>`;
    const empty=els.hist.querySelector('div[style]'); if(empty) empty.remove();
    els.hist.prepend(row); while(els.hist.children.length>60) els.hist.lastElementChild.remove();
    historyRows.unshift({time:d,item,typed,ok,sec,mode}); while(historyRows.length>300) historyRows.pop();
  }
  window.exportCSV=function(){ const header=['Heure','Item','Saisi','Juste','Secondes','Mode']; const rows=historyRows.map(r=>[r.time,r.item,r.typed,r.ok?'1':'0',r.sec,r.mode]); const csv=[header,...rows].map(line=>line.map(v=>`"${String(v).replaceAll('"','""')}"`).join(';')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cassandre_tap_tap.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); };
  window.resetStats=function(){ if(!confirm('R√©initialiser score, s√©rie, total et historique ?')) return; score=0; streak=0; total=0; okCount=0; updateStats(); els.hist.innerHTML='<div style="text-align:center;color:#999;padding:20px;">L\'historique appara√Ætra ici</div>'; save(); };

  // ----- Clavier visuel : highlight & press -----
  function clearTargets(){ document.querySelectorAll('.key.target').forEach(k=>k.classList.remove('target')); }
  function highlightTargetKey(ch){ clearTargets(); const k=document.querySelector(`.key[data-key="${normalizeKey(ch)}"]`); if(k) k.classList.add('target'); }
  function pulseKey(ch){ const k=document.querySelector(`.key[data-key="${normalizeKey(ch)}"]`); if(k){ k.classList.add('active'); setTimeout(()=>k.classList.remove('active'), 120); } }
  function flashTarget(){ const el=document.querySelector('.key.target'); if(!el) return; el.animate([{transform:'scale(1)'},{transform:'scale(1.12)'},{transform:'scale(1)'}],{duration:300,easing:'ease-out'}); }

  // ----- Confettis -----
  function confetti(n=100){ const c=els.cel; for(let i=0;i<n;i++){ const d=document.createElement('div'); d.className='confetti'; d.style.left=Math.random()*100+'vw'; d.style.background=`hsl(${Math.random()*360},90%,60%)`; d.style.animationDelay=(Math.random()*2000)+'ms'; c.appendChild(d); setTimeout(()=>d.remove(),3200); } }

  // auto focus pour capter les touches (mobile)
  window.addEventListener('pointerdown', ()=> els.trap.focus());

  // D√©marrage
  newPrompt();
  save();
})();
</script>
</body>
</html>
